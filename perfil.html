<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil / DK</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;600;800&display=swap");

        body {
            font-family: 'Google Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        #profile-header {
            text-align: center;
            padding: 20px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
        }

        #profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }

        #profile-username {
            margin-top: 10px;
            font-size: 24px;
        }

        #posts-container {
            padding: 20px;
        }

        .post {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div id="profile-header">
    <img id="profile-picture" src="" alt="Foto de Perfil">
    <h1 id="profile-username"></h1>
    <p id="profile-link"></p> <!-- Novo campo para o link do perfil -->
</div>

<div id="posts-container">
    <!-- Posts serão inseridos aqui dinamicamente -->
</div>

<script type="module">
    // Importe os módulos necessários do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Configuração do Firebase (substitua com suas credenciais)
    const firebaseConfig = {
        apiKey: "AIzaSyAX52Zf503k8hH-3KTbnRhoVp7ZZFsAvVc",
        authDomain: "dksocial-2ca10.firebaseapp.com",
        databaseURL: "https://dksocial-2ca10-default-rtdb.firebaseio.com",
        projectId: "dksocial-2ca10",
        storageBucket: "dksocial-2ca10.appspot.com",
        messagingSenderId: "227561021292",
        appId: "1:227561021292:web:91b3a5c37fc6b9e6ae9d49",
        measurementId: "G-LZ7B5D54S1"
    };

    // Inicialize o Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app); // Realtime Database
    const db = getFirestore(app); // Firestore

    // Função para extrair o username da URL
    function getUsernameFromUrl() {
        const path = window.location.href; // Pega a URL completa
        const url = new URL(path); // Cria um objeto URL
        const pathname = url.pathname; // Pega o caminho da URL (ex: "/perfil.html/@username")
        const parts = pathname.split('/'); // Divide o caminho em partes
        const usernamePart = parts.find(part => part.startsWith('@')); // Encontra a parte que começa com "@"
        if (usernamePart) {
            return usernamePart.slice(1); // Remove o "@" e retorna o username
        }
        return null; // Retorna null se não encontrar o username
    }

    // Função para carregar o perfil do usuário pelo username (Realtime Database)
    function loadProfileByUsername(username) {
        const usersRef = ref(database, 'users'); // Referência ao nó "users" no Realtime Database
        onValue(usersRef, (snapshot) => {
            const users = snapshot.val(); // Obtém todos os usuários
            if (users) {
                // Procura o usuário com o username correspondente
                const user = Object.values(users).find(u => u.username === username);
                if (user) {
                    console.log('Dados do usuário encontrados:', user); // Log para depuração
                    document.getElementById('profile-username').textContent = user.username;
                    if (user.profilePicture) {
                        document.getElementById('profile-picture').src = user.profilePicture;
                    }
                    // Carregar os posts do usuário (Firestore)
                    loadPosts(user.uid);
                } else {
                    console.error('Usuário não encontrado.');
                    document.getElementById('profile-username').textContent = 'Usuário não encontrado.';
                }
            } else {
                console.error('Nenhum usuário encontrado no banco de dados.');
            }
        }, (error) => {
            console.error('Erro ao carregar perfil:', error);
        });
    }

    // Função para carregar os posts do usuário (Firestore)
    async function loadPosts(uid) {
        const postsContainer = document.getElementById('posts-container');
        postsContainer.innerHTML = ''; // Limpar posts anteriores

        try {
            // Consulta para buscar os posts do usuário
            const postsQuery = query(collection(db, 'tweets'), where('userId', '==', uid));
            const querySnapshot = await getDocs(postsQuery);

            if (!querySnapshot.empty) {
                querySnapshot.forEach((doc) => {
                    const post = doc.data();
                    const postElement = document.createElement('div');
                    postElement.className = 'post';
                    postElement.innerHTML = `
                        <img src="${post.profilePicture}" alt="Foto de Perfil" style="width: 50px; height: 50px; border-radius: 50%;">
                        <p><strong>${post.username}</strong></p>
                        <p>${post.text}</p>
                        <small>Postado em: ${post.createdAt.toDate().toLocaleString()}</small>
                    `;
                    postsContainer.appendChild(postElement);
                });
            } else {
                postsContainer.innerHTML = '<p>Nenhum post encontrado.</p>';
            }
        } catch (error) {
            console.error('Erro ao carregar posts:', error);
            postsContainer.innerHTML = '<p>Erro ao carregar posts. Tente novamente mais tarde.</p>';
        }
    }

    // Verifique se o usuário está autenticado
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Usuário autenticado
            const usernameFromUrl = getUsernameFromUrl();
            if (usernameFromUrl) {
                // Se houver um username na URL, carregar o perfil correspondente
                loadProfileByUsername(usernameFromUrl);
            } else {
                // Se não houver username na URL, carregar o perfil do usuário logado
                loadProfileByUsername(user.username); // Supondo que o username do usuário logado esteja disponível
            }
        } else {
            // Usuário não autenticado, redirecionar para a página de login
            window.location.href = 'index.html';
        }
    });
</script>
</body>
</html>
